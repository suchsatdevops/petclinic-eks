name: 'Namespace Label Check'
on:
  pull_request:
    paths:
      - 'src/**/namespace.yaml'
      - 'src/**/ns*.yaml'
      - 'src/**/*ns*.yaml'

jobs:
  check-labels:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Identify all files in PR
      id: files
      uses: trilom/file-changes-action@v1.2.4
      with:
        output: ' '

    - name: Check for Namespace Labels
      id: check
      continue-on-error: true
      # "bash {0}" will make all commands run regardless of any one command fails
      shell: bash {0}
      run: |
        all_files="${{ steps.files.outputs.all }}"
        if [[ ! -z "$all_files" ]];
        then
          for file in $all_files; do
            if [[ ( "$(basename $file)" == "namespace.yaml" || "$(basename $file)" == "*ns*.yaml" ) && -n $(echo "$file" |grep "clusters/") ]];
            then
              export label=$(cat $file | grep 'istio.io/rev')
              echo $label
              if $label == istio.io/rev*; then
                echo "Error: Namespace labels found."
                exit 1
              else
                echo "Namespace labels not found, PR looks good"
              fi
            fi
          done
        fi
